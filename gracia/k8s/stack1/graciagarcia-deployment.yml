

apiVersion: apps/v1                     # Versión de la API de Kubernetes para Deployments
kind: Deployment                        # Tipo de recurso: Deployment (despliegue de aplicación)
metadata:                               # Metadatos del deployment
  name: graciagarcia-deployment         # Nombre del deployment
  namespace: graciagarcia-namespace     # Namespace donde se desplegará
  labels:                               # Etiquetas para identificar el deployment
    app: graciagarcia-app               # Etiqueta de la aplicación
    version: v1                         # Versión de la aplicación
    owner: graciagarcia                 # Propietario
spec:                                   # Especificación del deployment
  replicas: 3                           # Número de réplicas (pods) a crear: 3
  selector:                               # Selector para identificar los pods
    matchLabels:                        # Etiquetas que deben coincidir
      app: graciagarcia-app             # Selecciona pods con esta etiqueta
  template:                             # Plantilla para crear los pods
    metadata:                           # Metadatos de los pods
      labels:                           # Etiquetas de los pods
        app: graciagarcia-app           # Etiqueta de la aplicación
        version: v1                     # Versión
    spec:                               # Especificación de los pods
      containers:                       # Lista de contenedores en el pod
      - name: graciagarcia-container    # Nombre del contenedor principal
        image: 60071325/ht-232-03-gracia-garcia:latest  # Imagen de Docker Hub
        imagePullPolicy: Always         # Siempre descargar la última versión
        ports:                          # Puertos expuestos por el contenedor
        - containerPort: 8093           # Puerto interno del contenedor: 8093
          name: http                    # Nombre del puerto
          protocol: TCP                 # Protocolo TCP
        env:                            # Variables de entorno
        - name: PORT                    # Variable PORT
          value: "8093"                 # Valor: 8093 (puerto de la app)
        - name: SPRING_DATASOURCE_URL   # URL de la base de datos H2
          value: "jdbc:h2:mem:testdb"   # H2 en memoria
        - name: SPRING_DATASOURCE_USERNAME  # Usuario de H2
          value: "sa"                   # Usuario: sa
        - name: SPRING_DATASOURCE_PASSWORD  # Contraseña de H2
          value: ""                     # Contraseña vacía
        resources:                          # Recursos del contenedor
          requests:                     # Recursos mínimos solicitados
            memory: "256Mi"             # Memoria mínima: 256 MB
            cpu: "250m"                 # CPU mínima: 0.25 cores
          limits:                       # Límites máximos de recursos
            memory: "512Mi"             # Memoria máxima: 512 MB
            cpu: "500m"                 # CPU máxima: 0.5 cores
        livenessProbe:                  # Verifica si el contenedor está vivo
          httpGet:                      # Hace una petición HTTP
            path: /v1/api/student       # Endpoint a verificar
            port: 8093                  # Puerto a verificar
          initialDelaySeconds: 60       # Espera 60s antes de la primera verificación
          periodSeconds: 10             # Verifica cada 10 segundos
          timeoutSeconds: 5             # Timeout de 5 segundos
          failureThreshold: 3           # Reinicia después de 3 fallos
        readinessProbe:                 # Verifica si el contenedor está listo
          httpGet:                      # Hace una petición HTTP
            path: /v1/api/student       # Endpoint a verificar
            port: 8093                  # Puerto a verificar
          initialDelaySeconds: 30       # Espera 30s antes de la primera verificación
          periodSeconds: 5              # Verifica cada 5 segundos
          timeoutSeconds: 3             # Timeout de 3 segundos
          failureThreshold: 3           # Marca como no listo después de 3 fallos
      - name: busybox-sidecar           # Contenedor sidecar (segundo contenedor)
        image: busybox:latest           # Imagen ligera de busybox
        command: ['sh', '-c', 'while true; do echo "Sidecar running..."; sleep 30; done']
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"
      restartPolicy: Always             # Siempre reiniciar el pod si falla
